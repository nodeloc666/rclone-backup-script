# ğŸ›¡ï¸ Universal Backup & Notification Script

![Language](https://img.shields.io/badge/language-Bash-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
![Works With](https://img.shields.io/badge/works%20with-Cron-lightgrey.svg)
![Notifications](https://img.shields.io/badge/notifications-WeCom%20%7C%20DingTalk%20%7C%20Feishu%20%7C%20Telegram-brightgreen)

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€é…ç½®çµæ´»çš„é€šç”¨æ•°æ®å¤‡ä»½è„šæœ¬ã€‚å®ƒèƒ½è‡ªåŠ¨å®Œæˆæ•°æ®æ‰“åŒ…ã€åŠ å¯†ã€ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼Œå¹¶èƒ½é€šè¿‡ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ã€Telegram ç­‰å¤šç§æ¸ é“å‘é€ä¸°å¯Œçš„çŠ¶æ€é€šçŸ¥ã€‚

---

## ğŸ“š ç›®å½•

- [âœ¨ ä¸»è¦åŠŸèƒ½](#-ä¸»è¦åŠŸèƒ½)
- [ğŸ—ºï¸ å·¥ä½œæµç¨‹](#ï¸-å·¥ä½œæµç¨‹)
- [ğŸš€ å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
- [ğŸ› ï¸ é…ç½®æŒ‡å—](#ï¸-é…ç½®æŒ‡å—)
  - [å˜é‡è¯¦è§£](#å˜é‡è¯¦è§£)
- [âš™ï¸ ä½¿ç”¨æ–¹æ³•](#ï¸-ä½¿ç”¨æ–¹æ³•)
  - [1. èµ‹äºˆæ‰§è¡Œæƒé™](#1-èµ‹äºˆæ‰§è¡Œæƒé™)
  - [2. è®¾ç½®åŠ å¯†å¯†ç  (å®‰å…¨è­¦å‘Š)](#2-è®¾ç½®åŠ å¯†å¯†ç -å®‰å…¨è­¦å‘Š)
  - [3. æ‰‹åŠ¨æ‰§è¡Œä¸æµ‹è¯•](#3-æ‰‹åŠ¨æ‰§è¡Œä¸æµ‹è¯•)
  - [4. è®¾ç½®å®šæ—¶ä»»åŠ¡ (Cron)](#4-è®¾ç½®å®šæ—¶ä»»åŠ¡-cron)
- [ğŸ“¦ é€šçŸ¥æ ¼å¼è¯¦è§£ (Payloads)](#-é€šçŸ¥æ ¼å¼è¯¦è§£-payloads)
- [ğŸ“‹ ä¾èµ–ç»„ä»¶](#-ä¾èµ–ç»„ä»¶)
- [ğŸ“„ è®¸å¯](#-è®¸å¯)

---

## âœ¨ ä¸»è¦åŠŸèƒ½

-   ğŸ“‚ **è‡ªåŠ¨åŒ–å¤‡ä»½**: è‡ªåŠ¨æ‰“åŒ…æŒ‡å®šç›®å½•ã€‚
-   ğŸ” **AES åŠ å¯†**: ä½¿ç”¨ `zip` çš„å†…ç½®åŠ å¯†åŠŸèƒ½ä¿æŠ¤å¤‡ä»½æ–‡ä»¶å®‰å…¨ã€‚
-   â˜ï¸ **äº‘ç«¯åŒæ­¥**: æ— ç¼é›†æˆ [Rclone](https://rclone.org/)ï¼Œæ”¯æŒå°†å¤‡ä»½ä¸Šä¼ åˆ°ä»»ä½• Rclone æ”¯æŒçš„äº‘å­˜å‚¨æœåŠ¡ï¼ˆå¦‚ S3, Google Drive, R2 ç­‰ï¼‰ã€‚
-   â™»ï¸ **æ™ºèƒ½è¿œç¨‹æ¸…ç†**: è‡ªåŠ¨åˆ é™¤äº‘ç«¯çš„æ—§å¤‡ä»½ï¼Œä»…ä¿ç•™æŒ‡å®šæ•°é‡çš„æœ€æ–°ç‰ˆæœ¬ã€‚
-   ğŸ“¢ **å¤šæ¸ é“é€šçŸ¥**: åŸç”Ÿæ”¯æŒä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ã€Telegram å’Œé€šç”¨ Webhookï¼Œå‘é€æ ¼å¼ç²¾ç¾çš„æˆåŠŸæˆ–å¤±è´¥é€šçŸ¥ã€‚
-   -   **å¼ºå¤§çš„é”™è¯¯å¤„ç†**: è®°å½•è¯¦ç»†çš„å¤±è´¥åŸå› ï¼Œå¹¶åœ¨å¤±è´¥æ—¶ç«‹å³é€€å‡ºã€‚

## ğŸ—ºï¸ å·¥ä½œæµç¨‹

è„šæœ¬çš„æ‰§è¡Œæµç¨‹æ¸…æ™°æ˜äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```mermaid
graph TD
    A[æºæ•°æ®ç›®å½•] --> B{æ‰“åŒ…å¹¶åŠ å¯†};
    B --> C[ç”Ÿæˆä¸´æ—¶çš„ .zip æ–‡ä»¶];
    C --> D{ä¸Šä¼ åˆ° Rclone äº‘ç«¯};
    D --> E{åˆ é™¤æœ¬åœ°ä¸´æ—¶æ–‡ä»¶};
    E --> F{æ¸…ç†äº‘ç«¯æ—§å¤‡ä»½};
    F --> G[âœ… ä»»åŠ¡æˆåŠŸ]

    subgraph é€šçŸ¥ç³»ç»Ÿ
        G --> H{å‘é€æˆåŠŸé€šçŸ¥};
        I --> J{å‘é€å¤±è´¥é€šçŸ¥};
    end
    
    B --> I[âŒ å¤±è´¥];
    D --> I[âŒ å¤±è´¥];
    F --> I[âŒ å¤±è´¥];
```
---

## ğŸš€ å¿«é€Ÿå¼€å§‹

æ‚¨å¯ä»¥ä½¿ç”¨ `wget` æˆ– `curl` ä¸‹è½½æ­¤è„šæœ¬ã€‚æ¨èå°†å…¶é‡å‘½åä¸º `backup.sh` ä»¥æ–¹ä¾¿ç®¡ç†ã€‚

> **æç¤º**: è¯·å°†ä¸‹é¢çš„å ä½ç¬¦ URL æ›¿æ¢ä¸ºè„šæœ¬çš„çœŸå® Raw æ–‡ä»¶é“¾æ¥ï¼ˆä¾‹å¦‚ï¼Œä» Gist æˆ– GitHub ä»“åº“è·å–ï¼‰ã€‚

#### ä½¿ç”¨ `wget`

```sh
wget -O backup.sh https://gist.githubusercontent.com/username/gist_id/raw/script_version/backup_script.sh
```

#### ä½¿ç”¨ `curl`

```sh
curl -L -o backup.sh https://gist.githubusercontent.com/username/gist_id/raw/script_version/backup_script.sh
```
---

## ğŸ› ï¸ é…ç½®æŒ‡å—

ä¸‹è½½è„šæœ¬åï¼Œä½¿ç”¨ä½ å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚ `vim` æˆ– `nano`ï¼‰æ‰“å¼€ `backup.sh` æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹ `User Configuration Section` éƒ¨åˆ†çš„å˜é‡ã€‚

> **é‡è¦**: åœ¨å¼€å§‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»é€šè¿‡ `rclone config` å‘½ä»¤æ­£ç¡®é…ç½®äº† Rcloneï¼Œä»¥ä¾¿ `RCLONE_TARGET` ä¸­çš„è¿œç¨‹ä»“åº“åç§°æœ‰æ•ˆã€‚

### å˜é‡è¯¦è§£

| å˜é‡å                      | æè¿°                                                                                                      | ç¤ºä¾‹å€¼                                                    |
| --------------------------- | --------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| `PROJECT_NAME`              | ä½ çš„é¡¹ç›®åç§°ï¼Œå°†ç”¨äºå‘½åå’Œé€šçŸ¥ã€‚                                                                          | `"MyWebApp"`                                              |
| `SOURCE_DIR`                | éœ€è¦å¤‡ä»½çš„æºç›®å½•çš„ç»å¯¹è·¯å¾„ã€‚                                                                              | `"/var/www/mywebapp"`                                     |
| `LOG_FILE`                  | è„šæœ¬æ‰§è¡Œæ—¥å¿—çš„å­˜æ”¾è·¯å¾„ã€‚                                                                            | `"/var/log/mywebapp_backup.log"`                          |
| `TEMP_BACKUP_DIR`           | å­˜æ”¾ä¸´æ—¶ç”Ÿæˆçš„ `.zip` å¤‡ä»½æ–‡ä»¶çš„ç›®å½•ã€‚                                                                    | `"/var/backups"`                                          |
| `RCLONE_TARGET`             | Rclone çš„ç›®æ ‡è·¯å¾„ï¼Œæ ¼å¼ä¸º `RemoteName:path/to/dir`ã€‚                                                      | `"S3:/my-backups/webapp"`                                 |
| `BACKUP_RETENTION_COUNT`    | åœ¨äº‘ç«¯ä¿ç•™çš„æœ€æ–°å¤‡ä»½æ–‡ä»¶æ•°é‡ã€‚                                                                            | `5`                                                       |
| `KEEP_LOCAL_BACKUP`         | æ˜¯å¦åœ¨ä¸Šä¼ æˆåŠŸåä¿ç•™æœ¬åœ°çš„ `.zip` æ–‡ä»¶ã€‚                                                                  | `"false"`                                                 |
| `NOTIFICATION_MODE`         | é€šçŸ¥æ¨¡å¼ï¼š`all`, `failure`, `success`, `none`ã€‚                                                           | `"failure"`                                               |
| `NOTIFICATION_PROVIDER`     | é€šçŸ¥æœåŠ¡å•†ï¼š`wecom`, `dingtalk`, `feishu`, `telegram`, `generic`, `none`ã€‚                                 | `"wecom"`                                                 |
| `WEBHOOK_URL`               | ä½ çš„æœºå™¨äºº Webhook URL æˆ– Telegram Bot API åœ°å€ã€‚                                                         | `"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=..."` |
| `TELEGRAM_CHAT_ID`          | **ä»…å½“** `NOTIFICATION_PROVIDER` ä¸º `"telegram"` æ—¶éœ€è¦ã€‚                                                   | `"-100123456789"`                                         |

---

## âš™ï¸ ä½¿ç”¨æ–¹æ³•

### 1. èµ‹äºˆæ‰§è¡Œæƒé™

ä¸‹è½½è„šæœ¬åï¼Œé¦–å…ˆéœ€è¦ç»™å®ƒæ·»åŠ æ‰§è¡Œæƒé™ã€‚

```sh
chmod +x backup.sh
```

### 2. è®¾ç½®åŠ å¯†å¯†ç  (å®‰å…¨è­¦å‘Š)

è„šæœ¬é€šè¿‡è¯»å–ç¯å¢ƒå˜é‡ `ENCRYPTION_PASSWORD` æ¥è·å–åŠ å¯†å¯†ç ã€‚

> **å®‰å…¨æœ€ä½³å®è·µ**: **æ°¸è¿œä¸è¦å°†å¯†ç ç¡¬ç¼–ç åœ¨è„šæœ¬ä¸­ï¼** ä½¿ç”¨ç¯å¢ƒå˜é‡å¯ä»¥é¿å…å°†æ•æ„Ÿä¿¡æ¯æš´éœ²åœ¨æ–‡ä»¶ä¸­ã€‚ç›´æ¥åœ¨å‘½ä»¤è¡Œ `export` ä¼šå°†å¯†ç ç•™åœ¨ä½ çš„ shell å†å²è®°å½•ä¸­ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ç®¡ç†å¯†é’¥ï¼ˆå¦‚ Vault, AWS Secrets Manager, æˆ– `source` ä¸€ä¸ªå—é™æƒé™çš„æ–‡ä»¶ï¼‰ã€‚


åœ¨ç»ˆç«¯ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```sh
export ENCRYPTION_PASSWORD="Your-Super-Secret-Password-Here-123!"
```

### 3. æ‰‹åŠ¨æ‰§è¡Œä¸æµ‹è¯•

åœ¨é…ç½®å¥½å¹¶è®¾ç½®äº†å¯†ç åï¼Œå¯ä»¥ç›´æ¥è¿è¡Œè„šæœ¬è¿›è¡Œä¸€æ¬¡æ‰‹åŠ¨å¤‡ä»½æµ‹è¯•ã€‚

```sh
./backup.sh
```

å®Œæˆåï¼Œæ£€æŸ¥æ—¥å¿—æ–‡ä»¶ (`LOG_FILE` ä¸­é…ç½®çš„è·¯å¾„) å’Œä½ çš„é€šçŸ¥æ¸ é“ï¼Œç¡®ä¿ä¸€åˆ‡å·¥ä½œæ­£å¸¸ã€‚

### 4. è®¾ç½®å®šæ—¶ä»»åŠ¡ (Cron)

ä½¿ç”¨ `cron` å®ç°è‡ªåŠ¨åŒ–å®šæ—¶å¤‡ä»½æ˜¯æœ€ç»ˆç›®çš„ã€‚

1.  æ‰“å¼€ä½ çš„ crontab ç¼–è¾‘å™¨ï¼š
    ```sh
    crontab -e
    ```

2.  åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€è¡Œæ¥å®šä¹‰å®šæ—¶ä»»åŠ¡ã€‚å°†ç¯å¢ƒå˜é‡çš„å®šä¹‰å’Œå‘½ä»¤æ”¾åœ¨åŒä¸€è¡Œæ˜¯æ¨èçš„åšæ³•ã€‚

    **ç¤ºä¾‹**: æ¯å¤©å‡Œæ™¨ 3:00 æ‰§è¡Œå¤‡ä»½
    ```crontab
    # Backup for MyWebApp project
    0 3 * * * ENCRYPTION_PASSWORD="Your-Super-Secret-Password-Here-123!" /path/to/your/backup.sh
    ```
    > åˆ«å¿˜äº†å°† `/path/to/your/backup.sh` æ›¿æ¢ä¸ºè„šæœ¬çš„ **ç»å¯¹è·¯å¾„**ã€‚

---

## ğŸ“¦ é€šçŸ¥æ ¼å¼è¯¦è§£ (Payloads)

äº†è§£è„šæœ¬å‘é€çš„ JSON æ ¼å¼æœ‰åŠ©äºä½ è¿›è¡Œè°ƒè¯•æˆ–ä¸è‡ªå®šä¹‰æœåŠ¡é›†æˆã€‚ç‚¹å‡»ä¸‹æ–¹å¯å±•å¼€æŸ¥çœ‹å„æ¸ é“çš„æ ¼å¼ã€‚

<details>
<summary><strong>ä¼ä¸šå¾®ä¿¡ (wecom)</strong></summary>

ä½¿ç”¨ `markdown` ç±»å‹ï¼Œæ”¯æŒé¢œè‰²å’Œæ ¼å¼åŒ–ã€‚

```json
{
  "msgtype": "markdown",
  "markdown": {
    "content": "### {é¡¹ç›®å} Backup Notification\n> **Project:** `{é¡¹ç›®å}`\n> **Server:** `{æœåŠ¡å™¨å}`\n> **Status:** <font color=\"{é¢œè‰²}\">{çŠ¶æ€}</font>\n> **Message:** {å…·ä½“æ¶ˆæ¯}"
  }
}
```
</details>

<details>
<summary><strong>é’‰é’‰ (dingtalk)</strong></summary>

ä½¿ç”¨ `markdown` ç±»å‹ã€‚**æ³¨æ„**: è¯·åœ¨é’‰é’‰æœºå™¨äººå®‰å…¨è®¾ç½®ä¸­æ·»åŠ å…³é”®è¯ `Backup`ã€‚

```json
{
  "msgtype": "markdown",
  "markdown": {
    "title": "Backup Notification: {é¡¹ç›®å} {çŠ¶æ€}",
    "text": "### {æ ‡é¢˜}\n\n**Server:** {æœåŠ¡å™¨å}\n\n**Status:** <font color='{é¢œè‰²}'>{çŠ¶æ€}</font>\n\n**Details:** {å…·ä½“æ¶ˆæ¯}"
  }
}
```
</details>

<details>
<summary><strong>é£ä¹¦ (feishu)</strong></summary>

ä½¿ç”¨ç®€å•çš„ `text` ç±»å‹ï¼Œå…¼å®¹æ€§æœ€å¥½ã€‚

```json
{
  "msg_type": "text",
  "content": {
    "text": "ã€{è¡¨æƒ…} Backup Notificationã€‘\nProject: {é¡¹ç›®å}\nServer: {æœåŠ¡å™¨å}\nStatus: {çŠ¶æ€}\nMessage: {å…·ä½“æ¶ˆæ¯}"
  }
}
```
</details>

<details>
<summary><strong>Telegram (telegram)</strong></summary>

ä¸ä½¿ç”¨ JSON Bodyï¼Œè€Œæ˜¯é€šè¿‡ **HTTP GET è¯·æ±‚çš„ URL å‚æ•°** å‘é€ã€‚

-   **URL æ ¼å¼**: `https://api.telegram.org/bot<TOKEN>/sendMessage?chat_id=<ID>&parse_mode=Markdown&text=<URLç¼–ç åçš„æ–‡æœ¬>`
-   **æ¶ˆæ¯æ–‡æœ¬æ ¼å¼ (Markdown)**:
    ```
    *{è¡¨æƒ…} Backup Notification* ({é¡¹ç›®å})

    *Host:* `{æœåŠ¡å™¨å}`
    *Status:* *{çŠ¶æ€}*
    *Message:* {å…·ä½“æ¶ˆæ¯}
    ```
</details>

<details>
<summary><strong>é€šç”¨ Webhook (generic)</strong></summary>

ä¸€ä¸ªç®€å•ã€æ‰å¹³çš„ JSON ç»“æ„ï¼Œæ˜“äºä»»ä½•åç«¯æœåŠ¡è§£æã€‚

```json
{
  "project": "{é¡¹ç›®å}",
  "server": "{æœåŠ¡å™¨å}",
  "status": "{çŠ¶æ€}",
  "message": "{å…·ä½“æ¶ˆæ¯}"
}
```
</details>

---

## ğŸ“‹ ä¾èµ–ç»„ä»¶

è¯·ç¡®ä¿ä½ çš„ç³»ç»Ÿä¸Šå®‰è£…äº†ä»¥ä¸‹å‘½ä»¤è¡Œå·¥å…·ï¼š

-   `zip`: ç”¨äºæ‰“åŒ…å’ŒåŠ å¯†ã€‚
-   `rclone`: ç”¨äºä¸äº‘å­˜å‚¨åŒæ­¥ã€‚
-   `curl`: ç”¨äºå‘é€ Webhook é€šçŸ¥ã€‚

---

## ğŸ“„ è®¸å¯

æ­¤é¡¹ç›®æ ¹æ® [MIT License](LICENSE) æˆæƒã€‚
